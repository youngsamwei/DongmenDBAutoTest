<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
 <TITLE>201601060311_黄莹</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script type="text/javascript">
  <!--
   function ZweiFrames(URL1,F1,URL2,F2)
   {
    parent.frames[F1].location.href=URL1;
    parent.frames[F2].location.href=URL2;
   }
  //-->
  </script>
</HEAD>
<BODY BGCOLOR="#ffffff" style="margin-left:25">
<HR>
<H3><CENTER>02-exp_01_04_update.c</CENTER></H3><HR>
<PRE>
//
// Created by Sam on 2018/2/13.
//

#include &lt;parser/statement.h&gt;

/**
 * 在现有实现基础上，实现update from子句
 *
 * 支持的update语法：
 *
 * UPDATE &lt;table_name&gt; SET &lt;field1&gt; = &lt;expr1&gt;[, &lt;field2 = &lt;expr2&gt;, ..]
 * WHERE &lt;logical_expr&gt;
 *
 * 解析获得 sql_stmt_update 结构
 */
<A NAME="0"></A>/*TODO: parse_sql_stmt_update， update语句解析*/
bool parseAssignExpr(ParserT *parser, arraylist *fields, arraylist *fieldsExpr);
bool Ismatch(TokenT* token, TokenType a);
<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match189-0.html#0',2,'match189-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>sql_stmt_update *parse_sql_stmt_update(ParserT *parser){
    char *hyhyhyhyhyhyhyupdate_tableName = NULL;
    arraylist *hyhyhyhyhyhyhyupdatefields = arraylist_create(); //被更新的字段列表和新值列表
    arraylist *hyhyhyhyhyhyhyupdatevalues = arraylist_create();
    SRA_t *hyhyhyhyhyhyhyupdatewhere = NULL;
    TokenT *hyhyhyhyhyhyhyupdatetoken = NULL;
    // update &lt;table&gt; set &lt;&gt; = &lt;&gt;
    //判断update是否存在
    if (!matchToken(parser, TOKEN_RESERVED_WORD, &quot;update&quot;)) {
        return NULL;
    }

    //判断表是否存在
    hyhyhyhyhyhyhyupdatetoken = parseNextToken(parser);
    if (Ismatch(hyhyhyhyhyhyhyupdatetoken,TOKEN_WORD)) {
        hyhyhyhyhyhyhyupdate_tableName = new_id_name();
        strcpy(hyhyhyhyhyhyhyupdate_tableName, hyhyhyhyhyhyhyupdatetoken-&gt;text);
    } else {
        strcpy(parser-&gt;parserMessage, &quot;worning!!! worning!worning!worning!worning!worning!worning！invalid sql: missing table name.&quot;);
        return NULL;
    }
    //下一句是否set
    hyhyhyhyhyhyhyupdatetoken = parseEatAndNextToken(parser);
    if(!matchToken(parser, TOKEN_RESERVED_WORD, &quot;set&quot;)){
        strcpy(parser-&gt;parserMessage, &quot;worning!!! worning!worning!worning!worning!worning!worning！invalid sql: missing set.&quot;);
        return NULL;
    }
    //fprintf(stderr,&quot;set\n&quot;);
    //file 1
    //循环获取表单名，或者表单价值。
    if(!parseAssignExpr(parser,hyhyhyhyhyhyhyupdatefields,hyhyhyhyhyhyhyupdatevalues))
    {
        strcpy(parser-&gt;parserMessage, &quot;worning!!! worning!worning!worning!worning!worning!worning！ invalid sql: wrong fiel = &lt;expr&gt;.&quot;);
        return  NULL;
    }
    //where
    //表达式
    hyhyhyhyhyhyhyupdatewhere = SRATable(TableReference_make(hyhyhyhyhyhyhyupdate_tableName, NULL));
    hyhyhyhyhyhyhyupdatetoken = parseNextToken(parser);
    if(matchToken(parser, TOKEN_RESERVED_WORD, &quot;where&quot;) ) {
        Expression *whereExpr = parseExpressionRD(parser);
        hyhyhyhyhyhyhyupdatewhere = SRASelect(hyhyhyhyhyhyhyupdatewhere, whereExpr);
    }
    // fprintf(stderr,&quot; where....\n&quot;);
    sql_stmt_update  *sqlStmtUpdate = (sql_stmt_update *)calloc(sizeof(sql_stmt_update),1);
    sqlStmtUpdate-&gt;tableName = hyhyhyhyhyhyhyupdate_tableName;
    sqlStmtUpdate-&gt;fields = hyhyhyhyhyhyhyupdatefields;
    sqlStmtUpdate-&gt;fieldsExpr  = hyhyhyhyhyhyhyupdatevalues;
    sqlStmtUpdate-&gt;where = hyhyhyhyhyhyhyupdatewhere;
    // fprintf(stderr,&quot;the end happying ending......\n&quot;);
    return sqlStmtUpdate;
};
bool Ismatch(TokenT* token, TokenType a)
{
    if(token!=NULL &amp;&amp; token-&gt;type == a)
        return true;
    return  false;
}
bool  parseAssignExpr(ParserT *parser, arraylist *listvalue, arraylist *listExpr) {
    TokenT *token = parseNextToken(parser);
    while (1) {
        // field
        if (token!=NULL &amp;&amp; token-&gt;type == TOKEN_WORD) {
            //解析field名字
            char *hyhyhyhyhyhyhyfieldName = new_id_name();
            strcpy(hyhyhyhyhyhyhyfieldName, token-&gt;text);
            arraylist_add(listvalue, hyhyhyhyhyhyhyfieldName);
            token = parseEatAndNextToken(parser);
            //判断 =
            if (!matchToken(parser, TOKEN_EQ, &quot;=&quot;)) {
                return 0;
            }
            // 解析expr的值 expr
            Expression *expr = parseExpressionRD(parser);
            if (parser-&gt;parserStateType == PARSER_WRONG) {
                strcpy(parser-&gt;parserMessage, &quot;invalid sql: worning!!! worning!worning!worning!worning!worning!worning！ invalid value.&quot;);
                return 0;
            }
            arraylist_add(listExpr, expr);
            token = parseNextToken(parser);
            if (token != NULL &amp;&amp; token-&gt;type == TOKEN_COMMA) { //如果是逗号继续进行
                token = parseEatAndNextToken(parser);
            }else{
                break;
            }
        }
        else {
            strcpy(parser-&gt;parserMessage, &quot;worning!!! worning!worning!worning!worning!worning!worning！invalid sql: missing field name.&quot;);
            return 0;
        }
    }
    return 1;
};</B></FONT>
</PRE>
<HR>
<H3><CENTER>03-exp_07_05_update.c</CENTER></H3><HR>
<PRE>
//
// Created by sam on 2018/9/18.
//
#include &quot;physicalplan/physicalplan.h&quot;

/*执行 update 语句*/
/*TODO: plan_execute_update， update语句执行*/
int plan_execute_update(dongmendb *db, sql_stmt_update *sqlStmtUpdate , transaction *tx){
    /*删除语句以select的物理操作为基础实现。
     * 1. 使用 sql_stmt_update 的条件参数，调用 physical_scan_select_create 创建select的物理计划并初始化;
<A NAME="1"></A>     * 2. 执行 select 的物理计划，完成update操作
     * */
    char *hyhyhyhyhyhyhyupdatetableName = sqlStmtUpdate-&gt;tableName;
<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match189-0.html#1',2,'match189-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>    arraylist *hyhyhyhyhyhyhyupdatefields = sqlStmtUpdate-&gt;fields;
    arraylist *hyhyhyhyhyhyhyupdatefieldsExpr = sqlStmtUpdate-&gt;fieldsExpr;
    physical_scan *hyhyhyhyhyhyhyupdatescan = physical_scan_generate(db, sqlStmtUpdate-&gt;where, tx);
    hyhyhyhyhyhyhyupdatescan-&gt;beforeFirst(hyhyhyhyhyhyhyupdatescan);
    size_t updated_num = 0;
    while (hyhyhyhyhyhyhyupdatescan-&gt;next(hyhyhyhyhyhyhyupdatescan)) {
        for (size_t i = 0; i &lt; hyhyhyhyhyhyhyupdatefields-&gt;size; ++i) {
            char *cntFieldName = arraylist_get(hyhyhyhyhyhyhyupdatefields, i);
            variant *cntval = (variant *) calloc(sizeof(variant), 1);
            enum data_type field_type = hyhyhyhyhyhyhyupdatescan-&gt;getField(hyhyhyhyhyhyhyupdatescan, hyhyhyhyhyhyhyupdatetableName, cntFieldName)-&gt;type;
            physical_scan_evaluate_expression(arraylist_get(hyhyhyhyhyhyhyupdatefieldsExpr, i), hyhyhyhyhyhyhyupdatescan, cntval);
            if (cntval-&gt;type != field_type) {
                fprintf(stdout, &quot;invalid sql: field type mismatched.&quot;);
                return DONGMENDB_EINVALIDSQL;
            }
            if (cntval-&gt;type == DATA_TYPE_CHAR) {
                /*字符串超出定义时的长度，则截断字符串.*/
                int max_length_str = hyhyhyhyhyhyhyupdatescan-&gt;getField(hyhyhyhyhyhyhyupdatescan, hyhyhyhyhyhyhyupdatetableName, cntFieldName)-&gt;length;
                if (max_length_str &lt; strlen(cntval-&gt;strValue)) {
                    cntval-&gt;strValue[max_length_str] = '\0';
                }
                hyhyhyhyhyhyhyupdatescan-&gt;setString(hyhyhyhyhyhyhyupdatescan, hyhyhyhyhyhyhyupdatetableName, cntFieldName, cntval-&gt;strValue);
            }else if (cntval-&gt;type == DATA_TYPE_INT) {
                hyhyhyhyhyhyhyupdatescan-&gt;setInt(hyhyhyhyhyhyhyupdatescan, hyhyhyhyhyhyhyupdatetableName, cntFieldName, cntval-&gt;intValue);
            }
        }
        updated_num++;
    }
    hyhyhyhyhyhyhyupdatescan-&gt;close(hyhyhyhyhyhyhyupdatescan);
    return  updated_num ;;
};</B></FONT>
</PRE>
</BODY>
</HTML>
